<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="laskarisn@grnet.gr" id="advanced-group-management-plugin-v1.0">

        <createTable tableName="KEYCLOAK_GROUP_CONFIGURATION">
            <column name="GROUP_ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="DESCRIPTION" type="TEXT"/>
            <column name="ENROLLMENT_FLOW" type="VARCHAR(36)"/>
            <column name="AUP_ID" type="VARCHAR(36)"/>
        </createTable>

        <createTable tableName="KEYCLOAK_GROUP_AUP">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="MIMETYPE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="CONTENT" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="EDITOR" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="KEYCLOAK_GROUP_ENROLLMENT">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="USER_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="GROUP_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="KEYCLOAK_GROUP_ENROLLMENT_STATE">
            <column name="ENROLLMENT_ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="STATE" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="TIMESTAMP" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="JUSTIFICATION" type="TEXT"/>
            <column name="USER_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="GROUP_ID" type="VARCHAR(36)"/>
            <column name="DESCRIPTION" type="TEXT"/>
        </createTable>

        <createTable tableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW_PROPS">
            <column name="FLOW_ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="PROPERTY" type="VARCHAR(255)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>


        <createIndex indexName="KC_GROUP_CONFIG_IDX" tableName="KEYCLOAK_GROUP_CONFIGURATION">
            <column name="ENROLLMENT_FLOW"/>
            <column name="AUP_ID"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_CONFIG_EF_IDX" tableName="KEYCLOAK_GROUP_CONFIGURATION">
            <column name="ENROLLMENT_FLOW"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_CONFIG_AID_IDX" tableName="KEYCLOAK_GROUP_CONFIGURATION">
            <column name="AUP_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_cfg_gid"
                baseTableName="KEYCLOAK_GROUP_CONFIGURATION"
                baseColumnNames="GROUP_ID"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_cfg_ef"
                baseTableName="KEYCLOAK_GROUP_CONFIGURATION"
                baseColumnNames="enrollment_flow"
                referencedTableName="keycloak_group_enrollment_flow"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_cfg_aid"
                baseTableName="KEYCLOAK_GROUP_CONFIGURATION"
                baseColumnNames="aup_id"
                referencedTableName="keycloak_group_aup"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_AUP_ED_IDX" tableName="KEYCLOAK_GROUP_AUP">
            <column name="EDITOR"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_aup_editor"
                baseTableName="KEYCLOAK_GROUP_AUP"
                baseColumnNames="editor"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_UID_IDX" tableName="KEYCLOAK_GROUP_ENROLLMENT">
            <column name="USER_ID"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_ENROL_GID_IDX" tableName="KEYCLOAK_GROUP_ENROLLMENT">
            <column name="GROUP_ID"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_uid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT"
                baseColumnNames="user_id"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_gid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT"
                baseColumnNames="group_id"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_STATE_UID_IDX" tableName="KEYCLOAK_GROUP_ENROLLMENT_STATE">
            <column name="USER_ID"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_state_eid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT_STATE"
                baseColumnNames="enrollment_id"
                referencedTableName="keycloak_group_enrollment"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_state_uid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT_STATE"
                baseColumnNames="user_id"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_FLOW_GID_IDX" tableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW">
            <column name="GROUP_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_flow_gid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW"
                baseColumnNames="group_id"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_FLOW_PROPS_FID_IDX" tableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW_PROPS">
            <column name="FLOW_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_flow_props_fid"
                baseTableName="KEYCLOAK_GROUP_ENROLLMENT_FLOW_PROPS"
                baseColumnNames="flow_id"
                referencedTableName="keycloak_group_enrollment_flow"
                referencedColumnNames="id"
        />

    </changeSet>


</databaseChangeLog>
