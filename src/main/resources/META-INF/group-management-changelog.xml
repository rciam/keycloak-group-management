<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="laskarisn@grnet.gr" id="advanced-group-management-plugin-v1.0">

        <createTable tableName="USER_VO_GROUP_MEMBERSHIP">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="GROUP_ID" type="VARCHAR(36)" >
                <constraints nullable="false"/>
            </column>
            <column name="USER_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="STATUS" type="VARCHAR(255)" >
                <constraints nullable="false"/>
            </column>
            <column name="CHANGED_BY" type="VARCHAR(36)"/>
            <column name="MEMBERSHIP_EXPIRES_AT" type="timestamp" />
            <column name="AUP_EXPIRES_AT" type="timestamp" />
            <column name="JUSTIFICATION" type="text" />
        </createTable>

        <createIndex indexName="USER_VO_GROUP_MEMBERSHIP_GID" tableName="USER_VO_GROUP_MEMBERSHIP">
            <column name="GROUP_ID"/>
        </createIndex>

        <createIndex indexName="USER_VO_GROUP_MEMBERSHIP_UID" tableName="USER_VO_GROUP_MEMBERSHIP">
            <column name="USER_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_usr_vo_grp_mb_gid"
                baseTableName="USER_VO_GROUP_MEMBERSHIP"
                baseColumnNames="GROUP_ID"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />
        <addForeignKeyConstraint
                constraintName="fk_kc_usr_vo_grp_mb_uid"
                baseTableName="USER_VO_GROUP_MEMBERSHIP"
                baseColumnNames="USER_ID"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />
        <addForeignKeyConstraint
                constraintName="fk_kc_usr_vo_grp_mb_cb"
                baseTableName="USER_VO_GROUP_MEMBERSHIP"
                baseColumnNames="CHANGED_BY"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <createTable tableName="GROUP_CONFIGURATION">
            <column name="GROUP_ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="DESCRIPTION" type="TEXT"/>
            <column name="AUP_ID" type="VARCHAR(36)"/>
            <column name="REQUIRE_AUP_ACCEPTANCE" type="boolean"  defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="REQUIRE_APPROVAL" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="MEMBERSHIP_EXPIRATION_SEC" type="bigint" />
            <column name="AUP_EXPIRY_SEC" type="bigint"/>
        </createTable>

        <createTable tableName="GROUP_AUP">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="MIMETYPE" type="VARCHAR(255)"/>
            <column name="CONTENT" type="BLOB">
                <constraints nullable="false"/>
            </column>
            <column name="EDITOR" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="GROUP_ENROLLMENT">
            <column name="ID" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="USER_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="GROUP_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="GROUP_ENROLLMENT_STATE">
            <column name="id" type="varchar(36)" >
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="ENROLLMENT_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="STATE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TIMESTAMP" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="JUSTIFICATION" type="TEXT"/>
            <column name="USER_ID" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>


        <createIndex indexName="KC_GROUP_CONFIG_IDX" tableName="GROUP_CONFIGURATION">
            <column name="AUP_ID"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_CONFIG_AID_IDX" tableName="GROUP_CONFIGURATION">
            <column name="AUP_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_cfg_gid"
                baseTableName="GROUP_CONFIGURATION"
                baseColumnNames="GROUP_ID"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_cfg_aid"
                baseTableName="GROUP_CONFIGURATION"
                baseColumnNames="aup_id"
                referencedTableName="group_aup"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_AUP_ED_IDX" tableName="GROUP_AUP">
            <column name="EDITOR"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_aup_editor"
                baseTableName="GROUP_AUP"
                baseColumnNames="editor"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_UID_IDX" tableName="GROUP_ENROLLMENT">
            <column name="USER_ID"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_ENROL_GID_IDX" tableName="GROUP_ENROLLMENT">
            <column name="GROUP_ID"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_uid"
                baseTableName="GROUP_ENROLLMENT"
                baseColumnNames="user_id"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_gid"
                baseTableName="GROUP_ENROLLMENT"
                baseColumnNames="group_id"
                referencedTableName="keycloak_group"
                referencedColumnNames="id"
        />

        <createIndex indexName="KC_GROUP_ENROL_STATE_UID_IDX" tableName="GROUP_ENROLLMENT_STATE">
            <column name="USER_ID"/>
        </createIndex>

        <createIndex indexName="KC_GROUP_ENROL_STATE_ENROLID_IDX" tableName="GROUP_ENROLLMENT_STATE">
            <column name="ENROLLMENT_ID"/>
        </createIndex>


        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_state_eid"
                baseTableName="GROUP_ENROLLMENT_STATE"
                baseColumnNames="enrollment_id"
                referencedTableName="group_enrollment"
                referencedColumnNames="id"
        />

        <addForeignKeyConstraint
                constraintName="fk_kc_grp_enrol_state_uid"
                baseTableName="GROUP_ENROLLMENT_STATE"
                baseColumnNames="user_id"
                referencedTableName="user_entity"
                referencedColumnNames="id"
        />


    </changeSet>

    <changeSet author="laskarisn@grnet.gr" id="realm-group-enhancements">

        <createIndex indexName="KC_GROUP_REALMID_IDX" tableName="keycloak_group">
            <column name="REALM_ID"/>
        </createIndex>

        <addForeignKeyConstraint
                constraintName="fk_kc_group_realm_rid"
                baseTableName="keycloak_group"
                baseColumnNames="realm_id"
                referencedTableName="realm"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet author="cgeorgilakis@grnet.gr" id="vo-admin">

        <addColumn tableName="USER_VO_GROUP_MEMBERSHIP">
            <column name="IS_ADMIN" type="boolean"  defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="GROUP_AUP">
            <column name="URL" type="VARCHAR(255)"/>
        </addColumn>
        <dropNotNullConstraint tableName="GROUP_AUP" columnName="CONTENT" columnDataType="BLOB"/>
    </changeSet>


    <changeSet author="laskarisn@grnet.gr" id="group_config_isVO">
        <addColumn tableName="GROUP_CONFIGURATION">
            <column name="IS_VO" type="boolean"  defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


</databaseChangeLog>
